---
title: MBR-1
date: 2020-02-18 18:16:09
tags: [随笔]
categories: [软件,磁盘]
---

## 硬盘结构-主引导扇区-1/MBR-1

* 以下内容中的MBR特指主引导记录，而不泛指主引导扇区
* 主引导扇区泛指以下的所有内容
* 磁盘-机械硬盘概念

### MBR主引导记录(master boot record)

* 计算机访问硬盘时所必须读取的首个分区
* 用于记录本身的相关信息与硬盘各个分区的大小及位置信息
* 还包含了基本数据结构的信息
* 硬盘上的三维地址(柱面，磁头，扇区)=(0,0,1)
* 开头的446字节内容
> 后4个16个字节为磁盘分区表(DPT)
> 结束标志字:2字节结束标准(55AA)

* 对于硬盘而言，一个扇区可能的字节数为128×2n(n=0,1,2,3)
> 大多情况下，取n=2，即一个扇区(sector)的大小为512字节

**MBR主引导记录构成:**

* 启动代码
> 主引导记录最开头的第一阶段是引导代码
> 其中的硬盘引导程序的主要作用是检查分区表是否正确
> 同时在系统硬件完成自检后将控制权交给硬盘上的引导程序(如GNU GRUB)
> 此阶段不依赖任何操作系统
> 启动代码可以改变，以用于实现多系统引导

---

### 磁盘分区表(DPT)
* 磁盘分区表占据主引导扇区的64个字节(偏移01BEH--偏移01FDE)
* 可对四个分区的信息进行描述，其中每个分区的信息占据16个字节
* 字节定义:参考硬盘分区结构信息

* 示例:
* 假设某一分区在硬盘分区表的信息:
> `80 01 01 00 0B FE BF FC 3F 00 00 00 7E 86 BB 00`

* 说明:
> 最前面的"80"是一个分区的激活标志，表示系统可引导
> "01 01 00"表示分区开始的磁头号为1，开始的扇区号为1，开始的柱面号为0
> "0B"表示分区的系统类型是FAT32，其他比较常用的有04(FAT16)，07(NTFS)
> "FE BF FC"表示分区结束的磁头号为254，分区结束的扇区号为63、分区结束的柱面号为764
> "3F 00 00 00"表示首扇区的相对扇区号为63(小端序)
> "7E 86 BB 00"表示总扇区数为12289662(小端序)

* 对于大于8.4G的现代硬盘，CHS已经无法表示, BIOS使用LBA模式
> 对于超出的部分，CHS值通常设为0xFEFFFF，并加以忽略
> 直接使用Offset 0x08-0x0c的4字节相对值，再进行内部转换

* 结束标志字55，AA(偏移1FEH－偏移1FFH)
> 最后两个字节是检验主引导记录是否有效的标志

---

### 主引导扇区读取逻辑(流程):

1. BIOS加电/引导自检(Power On Self Test -- POST)
> BIOS执行内存地址为FFFF:0000H处的跳转指令，跳转到固化在ROM中的自检程序处，对系统硬件(包括内存)进行检查
2. 读取主引导记录(MBR)
> 当BIOS检查到硬件正常并与CMOS中的设置相符后，按照CMOS中对启动设备的设置顺序检测可用的启动设备
> BIOS将相应启动设备的第一个扇区(也就是MBR扇区)读入内存地址为0000:7C00H处
3. 检查0000:7DFEH-0000:7DFFH(MBR的结束标志位)是否等于55AAH，若不等于则转去尝试其他启动设备
> 如果没有启动设备满足要求则显示"NO ROM BASIC"然后死机
4. 检测到有启动设备满足要求后，BIOS将控制权交给相应启动设备
> 启动设备的MBR将自己复制到0000:0600H处，然后继续执行
5. 根据MBR中的引导代码启动引导程序(如GNU GRUB)

* BIOS不仅检查0000:7DFEH-0000:7DFFH（MBR的结束标志位）是否等于55AAH，往往还对磁盘是否有写保护、主引导扇区中是否存在活动分区等进行检查
* 如果发现磁盘有写保护，则显示磁盘写保护出错信息
* 如果发现磁盘中不存在活动分区，则显示类似如下的信息“Remove disk or other media Press any key to restart”

---

### 硬盘分区简述:

* MBR(主引导记录)只包含了64个字节的DPT(磁盘分区表)
> 因为每个分区需要占有16个字节，所以对于MBR型分区结构的硬盘，最多只能识别4个主要分区(Primary partition)
> 如果此时想要得到4个以上的主要分区，就需要引出拓展分区了
> 拓展分区被归类为主分区(是主分区的一种)
> 但与主分区在理论上不同的是拓展分区可以被划分为无数个逻辑分区

* 拓展分区
> 拓展分区中的逻辑驱动器的引导记录是链式的
> 每个逻辑分区都有一个扩展引导记录(EBR/结构类似于MBR)
> 其中表的第一项指向逻辑分区本身的引导扇区
> 第二项指向下一个逻辑驱动器的EBR，分区表的第三，第四项没有用到

* windows操作系统在一般情况下，只会划分一个主分区用于存储操作系统，其余全部划入拓展分区
* `[1-主分区]-[3-逻辑分区->N-逻辑分区]`

---

**MBR分区表与GPT分区表**

* MBR分区表
> MBR磁盘分区样式支持的最大卷为2TB(Terabytes)，并且最多四个主分区(或3个主分区，1个扩展分区和无限制的逻辑驱动器)

* GPT分区表
> GPT磁盘分区样式在理论上最大支持128个分隔，一个分割最大18 EB(Exabytes)
> GPT分区磁盘有备份分区表，用以提高分区数据结构的完整性
> 如果硬盘太大则必须改用GPT

* 操作系统限制问题
> 分区表本身需要占有一定空间，规划硬盘时留给分区表的空间决定了最多可以有多少个分区
> IA-64版Windows限制最多有128个分区，同时这也是EFI规定的分区表最小尺寸
> GPT与MBR在分区的磁盘不同点是GPT将至关重要的平台操作系统位于分区，而非位于非分区或隐藏分区
> 在UEFI系统上，通常是通过ESP分区中的EFI应用程序文件来引导GPT硬盘上的操作系统，而不是活动主分区上的引导程序

* 系统分区可以设为活动主分区，但不是必须的，需要根据引导程序而定
* 一个硬盘的分区个数还要受到分区大小的限制，因为硬盘是按照柱面分区的：一个分区至少要占一个柱面
* 现在的硬盘结构已经和老式硬盘有了很大区别，其寻址结构也不再是CHS寻址，所以这里的柱面大小不同于相关软件显示的柱面大小

* 对于物理结构上有n个面的硬盘，其分区空间的最小值为:`n*扇区/磁道*512字节`
* 根据16字节分区表的结构:当前分区的扇区数用4个字节表示，前面各分区扇区数的总和也是4个字节，而`232*512 ＝ 2 199 023 255 552 Byte`

---

### 相关概念:

* BIOS
* UEFI
* MBR
* GPT-GUID/GPT
> GUID磁碟分割表
> 全局唯一标识分区表
> 是一个实体硬盘的分区表的结构布局的标准
* 主分区/拓展分区/逻辑分区
* 磁盘/操作系统文件系统
> FAT/exFAT/NTFS
* RAM
* ROM
* BOOT
* GURB
* CHS
> 柱面-磁头-扇区(Cylinder-head-sector)
> 是早期对硬盘驱动器的每一个物理数据块进行编址的一种方法
> 就软盘驱动器而言，可对同一磁盘介质进行低级格式化而得到不同的容量
* LBA
* EFI
> 可扩展固件接口标准
* Buffer
> 硬盘缓存
* 硬盘数据接口
> ATA/SATA/SCSI/SAS/FC/电源接口
* 逻辑结构(机械硬盘)
* 物理结构(机械硬盘)
* 机械/固态/混合/硬盘/软盘

---

### 相关内容补充:

**硬盘分区结构信息**

|偏移|长度(字节)|意义|
|:----|:----|:----|
|00H|1|分区状态:00-->非活动分区；80-->活动分区(其它数值没有意义)|
|01H|1|分区起始磁头号(HEAD)，用到全部8位|
|02H|2|分区起始扇区号(SECTOR)，占据02H的位0－5；该分区的起始磁柱号(CYLINDER)，占据02H的位6－7和03H的全部8位|
|04H|1|文件系统标志位|
|05H|1|分区结束磁头号(HEAD)，用到全部8位|
|06H|2|分区结束扇区号(SECTOR)，占据06H的位0－5；该分区的结束磁柱号(CYLINDER)，占据06H的位6－7和07H的全部8位|
|08H|4|分区起始相对扇区号|
|0CH|4|分区总的扇区数|

---

**标准MBR结构**

**准确地址长度与描述:**

|Hex|Oct|Dec|描述|长度(字节)|
|:----:|:---:|:----:|:----:|:----:|
|0000|0000|0|代码区|440(最大446)|
|01B8|0670|440|选用磁盘标志|4|
|01BC|0674|444|一般为空值; 0x0000|2|
|01BE|0676|446|标准MBR分区表规划(四个16 byte的主分区表入口)|64|
|01FE|0776|510|55h-(MBR有效标志:0x55AA)|1|
|01FF|0777|511|AAh-(MBR有效标志:0x55AA)|1|

* MBR总大小:446字节+64字节+2字节=512字节(长度)

---

### 参考资料:

* CN-Linux引导程序[跳转](https://www.ibm.com/developerworks/cn/linux/l-linuxboot/)
> `https://www.ibm.com/developerworks/cn/linux/l-linuxboot/`

* CN-FAT详解-1[跳转](https://web.archive.org/web/20090725091233/http://www.raid-recovery.org/Article/sjhfdoc/200404/1.html)
> `https://web.archive.org/web/20090725091233/http://www.raid-recovery.org/Article/sjhfdoc/200404/1.html`

