---
title: GPT/GUID-1
date: 2020-02-18 20:50:55
tags: 随笔
categories: [软件,磁盘结构]
---

## 硬盘结构-主引导扇区-2/GPT-1

* GPT/GUID对应于MBR
* 基于UEFI标准

### MBR/GPT-GPT

* GPT-全局唯一标识分区表(GUID Partition Table）
* 实体硬盘的分区表的结构布局的标准
* 是[^1]可扩展固件接口(UEFI)标准的一部分
* 被用于替代BIOS系统中的一32bits来存储逻辑块地址和大小信息的主引导记录(MBR)分区表
[^1]:被Intel用于替代个人计算机的BIOS

---

### GPT-特点:

* 在MBR硬盘中，分区信息直接存储于主引导记录(MBR)中(主引导记录中还存储着系统的引导程序)
* 在GPT硬盘中，分区表的位置信息储存在GPT头中
* 但由于出于兼容性问题，硬盘的第一个扇区仍然用作MBR，之后才是GPT头
* 与现代的MBR一样，GPT也使用逻辑区块地址(LBA)取代了早期的CHS寻址方式
* 传统MBR信息存储于LBA 0，GPT头存储于LBA 1，接下来才是分区表本身
* 为了减少分区表损坏的风险，GPT在硬盘最后保存了一份分区表的副本

---

### 扇区简述

**第一扇区(LBA 0):**

* 传统MBR(LBA 0)
> 在GPT分区表的最开头，出于兼容性考虑仍然存储了一份传统的MBR
> 它用于防止不支持GPT的硬盘管理工具错误识别并破坏硬盘中的数据
> 这个MBR也可称之为保护MBR
> 不能识别GPT硬盘的操作系统通常会识别出一个未知类型的分区，并且拒绝对硬盘进行操作
> 可以完全避免用户特别要求删除其分区的危险
> 另外，能够识别GPT分区表的操作系统会检查保护MBR中的分区表
> 如果分区类型不是0xEE或者MBR分区表中有多个项，也会拒绝对硬盘进行操作
* 在支持从GPT启动的操作系统中，这里也用于存储第一阶段的启动代码
* 在保护MBR中，只有一个标识为0xEE的分区，以此来表示这块硬盘使用GPT分区表
* 在使用MBR/GPT混合分区表的硬盘中，这部分存储了GPT分区表的一部分分区(通常是前四个分区)
> 可以使不支持从GPT启动的操作系统从这个MBR启动，启动后只能操作MBR分区表中的分区

---

**第二分区(LBA 1):**

* 分区表头(LBA 1)
> 分区表头定义了硬盘的可用空间以及组成分区表的项的大小和数量
> EFI标准要求分区表最小要有16,384字节，即128个分区项的大小
* 分区表头还记录了这块硬盘的GUID
> 记录了分区表头本身的位置和大小(位置总是在LBA 1)以及备份分区表头和分区表的位置和大小(在硬盘的最后)
> 它还储存着它本身和分区表的CRC32校验
* 固件，引导程序和操作系统在启动时可以根据这个校验值来判断分区表是否出错
> 如果出错了，可以使用软件从硬盘最后的备份GPT中恢复整个分区表
> 如果备份GPT也校验错误，硬盘将不可使用
* 所以GPT硬盘的分区表不可以直接使用16进制编辑器修改
* 主分区表和备份分区表的头分别位于硬盘的第二个扇区(LBA 1)以及硬盘的最后一个扇区
* 备份分区表头中的信息是关于备份分区表的

---

**其他扇区(分区表本身):**

* GPT的分区表使用简单而直接的方式表示分区
* 一个分区表项的前16字节是分区类型GUID

* 例如
> EFI系统分区的GUID类型是`{C12A7328-F81F-11D2-BA4B-00A0C93EC93B}`
> 接下来的16字节是该分区唯一的GUID(这个GUID指的是该分区本身，而之前的GUID指的是该分区的类型)
> 再接下来是分区起始和末尾的64位LBA编号，以及分区的名字和属性

**GPT分区表项的格式:**

|起始字节|长度|内容|
|----:|:----:|:----|
|0|16字节|分区类型GUID|
|16|16字节|分区GUID|
|32|8字节|起始LBA(小端序)|
|40|8字节|末尾LBA|
|48|8字节|属性标签(如:60表示"只读")
|56|72字节|分区名(可以包括36个UTF-16(小端序)字符)|

---

* MBR与GPT之间提供了互相转换的机制
* 对于不同内核的操作系统有不同的GUID分区类型支持

---

### 相关概念

* GPT/GUID
* MBR
* LBA(逻辑区块地址)
* CHS(早期寻址方式)
* UEFI
* BIOS
* 磁道(Track)
* 柱面(Cylinder)
* 扇区(Sector)
* 磁头(Heads)
* 盘片(Platters)
* 磁盘的物理结构
* 磁盘的逻辑结构

---

**补充内容:**

**分区表头的格式:**

|起始字节|长度|内容|
|----:|:----:|:----|
|0|8字节|签名("EFI PART", 45 46 49 20 50 41 52 54)|
|8|4字节|修订(在1.0版中，值是00 00 01 00)|
|12|4字节|分区表头的大小(单位是字节，通常是92字节，即5C 00 00 00)|
|16|4字节|分区表头(第0－91字节)的CRC32校验，在计算时，把这个字段作为0处理，需要计算出分区序列的CRC32校验后再计算本字段|
|20|4字节|保留，必须是0|
|24|8字节|当前LBA(这个分区表头的位置)|
|32|8字节|备份LBA(另一个分区表头的位置)|
|40|8字节|第一个可用于分区的LBA(主分区表的最后一个LBA＋1)|
|48|8字节|最后一个可用于分区的LBA(备份分区表的第一个LBA-1)|
|56|16字节|硬盘GUID(在类UNIX系统中也叫UUID)|
|72|8字节|分区表项的起始LBA(在主分区表中是2)|
|80|4字节|分区表项的数量|
|84|4字节|一个分区表项的大小(通常是128)|
|88|4字节|分区序列的CRC32校验|
|92|`*`|保留，剩余的字节必须是0(对于512字节LBA的硬盘即是420个字节)|

