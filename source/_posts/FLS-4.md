---
title: FLS-4
date: 2020-02-22 18:33:46
tags: [随笔,GNU/Linux]
categories: [软件,GNU]
---

## LFS-4

### 制作步骤

---

**制作步骤设计:**

**分为三个阶段:**
* 一阶段:1.创建目标系统目录，2.创建临时系统目录，3. 建立预工具链
* 二阶段: 4.建立临时系统，5. 建立目标工具链
* 三阶段: 6.建立目标系统，7.收尾工作

---

1. 创建目标系统目录

* 先建立一个空白的分区用于存放目标系统，并保证在制作完成后可以从这个分区启动已经制作完的系统
* 将这个分区格式化为主系统能够识别的文件系统，比如`EXT3`，并将该分区挂载到主系统中的某个目录，比如`/opt/mylinux`，这个目录将作为目标系统的制作目录
* 另外，还需要人为的将制作中所需要的软件包放在某个目录内，该目录需要在已经制作完成的系统的运行环境中能够访问到
* 可以存放在目标系统制作的目录中，如建立一个`/opt/mylinux/source`目录并存放于其中

---

2. 创建临时系统目录

* 本步骤是为了在主系统制作临时系统(详情可见阶段一与阶段二)和使用临时系统来制作目标系统(详情可见阶段三)能够用同样的目录来访问临时系统的目录和文件
* 阶段二和阶段三分别在不同根目录的运行环境中，但都使用到了临时系统，如果想让临时系统以最小的改动就可以使其中的命令既可以在主系统所在的运行环境中正常工作，也可以在目的相同所在的运行环境中工作正常
* 最好的解决方式就是让两个环境中调用临时系统的目录路径是完全一样的

**执行步骤:**

* 在目标系统所在目录中创建一个存放临时系统的目录，如`/opt/mylinux/tools`
* 然后利用软链接文件的方式在主系统的根目录建立一个指向`/opt/mylinux/tools`的链接文件
* 该链接文件的文件名必须是`/tools`
* 不去先建立`/tools`，然后再在`/opt/mylinux`目录下建立一个指向`/tools`的同名软链接的原因
* 原因就是目标系统目录是主系统的根目录下的某个目录，主系统根目录的运行环境都可以正常访问目标系统中目录
* 而目标系统在进入以所在目录为根目录的运行环境后就无法访问主系统的其它目录中的内容了
* 所以将真正的内容存放在目录系统的目录中将能够保证各个制作阶段均能访问临时系统中的内容，并且保证访问路径一致

* 采用链接方式在不同阶段的方式关系(链接我呢见在不同环境中的访问关系)

**逻辑简述:**

**一阶段&二阶段->三阶段**
> `一阶段&二阶段:[主系统(/tools)]<->[目标系统所在目录(/opt/mylinux/tools)]`
> `三阶段:{运行主系统环境[主系统(/tools)]}-可以访问->{运行目标系统环境[目标系统(/tools)]}`
> 同时
> `三阶段:{运行目标系统环境[目标系统(/tools)]}-无法访问->{运行主系统环境[主系统(/tools)]}`

* 箭头代表链接关系，箭头指向的是实际目录，另一方则为链接文件
* 在一阶段与二阶段中`/tools`和`/opt/mylinux/tools`无论谁是链接文件都不影响互相访问
* 而在第三阶段，只有`/tools`是链接文件时才能互相访问，`/opt/mylinux/tools`(在目标系统环境中变为`/tools`)是链接文件时无法访问`/tools`中的内容
* 同时还可以使用目录映射的方式使两个阶段都能够正常访问临时系统，即有两种方法:一种是软连接的方式，另一种是目录映射的方式
* 本篇文章仅介绍软链接的方式

---

3. 建立预工具链
* 预工具链的作用是生成临时工具链，临时工具链是独立于主系统中的工具链，根据工具链的制作原则需要有一个外部依赖的工具链作为过渡，该工具链就是预工具链

**预工具链到临时工具链的制作过程与步骤**

1. 先完成预工具链的编译工具部分，此时预工具链是一个内部依赖的工具链，依赖主系统中的Glibc
2. 然后使用编译工具完成临时系统中的Glibc，该Glibc存放在临时系统目录中，作为临时工具链和临时系统所依赖的Glibc
3. 对预工具链进行调整，变为外部依赖的工具链，即可开始编译临时工具链中的编译工具，以此完成临时工具链
4. 预工具链是临时工具链的过渡工具链，可以将其存放在临时系统的目录中，临时工具链的安装会覆盖掉预工具链，也可以存放在其它目录下，但需要在用完后手工删除掉

**到此第一阶段的制作已经完成，即将开始第二阶段的制作过程**

---

4. 建立临时系统
* 现在已经完成了临时工具链，但仅仅有一个工具链还不能顺利的编译各种软件包，需要有各种各样的辅助命令来共同完成
* 当前还处于主系统运行环境中，主系统所附带的各种辅助命令目前都可以用于编译
* 为了切换到目标系统运行环境后还能继续使用这些辅助命令，就必须将这些辅助命令存放在目标系统运行环境所能访问到的目录中

* 建立临时系统的原因就是为了承前启后，前即为主系统，后则为目标系统

* 临时系统是目标系统建立前用于支撑目标系统运行环境的基本框架，目标系统需要人为的进行从头建立
* 即为一开始什么都没有，此时临时系统承担了运行环境的运作，包括提供用户的交互功能，编译软件包以及常用命令
* 因此临时系统中必须加入工具链，辅助命令，常用命令和支撑运行环境的程序(如Bash)

**逻辑简述(不同阶段切换过程中各个系统的内容)**

**一阶段开始->二阶段开始->三阶段开始->三阶段结束**
> 一阶段:`{一阶段开始，主系统运行环境内(/&/tools)[主系统(完整)/临时系统(无内容)]}-此时的目标系统内无内容`
> 二阶段:`{二阶段开始，主系统运行环境内(/&/tools)[主系统(完整)/临时系统(部分)]}-此时的目标系统内无内容`
> 三阶段:`{三阶段开始，目标系统运行环境内(/&/tools)[临时系统(完整)/目标系统(无内容)]}-{/[主系统(完整)]}`
> 三阶段:`{三阶段结束，目标系统运行环境内(/&/tools)[临时系统(完整)/目标系统(完整)]}-{/[主系统(完整)]}`

* 第三阶段开始时，目标系统的根目录(`/`)没有任何内容，只能靠临时系统提供各种编译和运行的功能
* 第三阶段完成后，目标系统已经完整，就可以不需要临时系统而直接运行了
* 可以了解到临时洗头膏必须拥有相对完整的运行能力，并且要独立于主系统，无论临时工具链还是临时系统中其它辅助命令都必须依赖临时系统中的函数库
* 临时系统必须全部由临时工具链来链接生成

* 此时临时系统的制作内容就非常明确了，如Bash，常用命令(Coreuils等)和工具链环境(Awk，Sed等)

---

5. 建立目标工具链

* 制作完成了临时系统后就要进入第三阶段的制作过程，即为将运行环境正式切换到目标系统运行环境
* 需要明确的是:目标系统最终是需要通过人为方式去将内容进行保留，临时系统在完成目标系统后就会被删除掉
* 目标系统同样需要一个内部链接的工具链，这是为了实现今后目标系统脱离主系统后能成为一个独立的系统且能够继续编译安装软件包

* 目标的临时工具链也是内部依赖的工具链，根据制作原则可以知道从内部依赖的工具链生成另外一个内部依赖的工具链需要有一个外部依赖的工具链作为过渡
* 此时已经不再编译临时系统上的程序文件了，可以通过调整工具链的方法将临时工具链内部依赖变为内部依赖，过渡用的外部依赖工具链就用调整临时工具链的方法来实现，临时工具链由此开始作为过渡工具链
* 根据工具链的制作原则，调整之前需要先建立好目标系统中的Glibc，这个Glibc同样根据工具链制作原则存放在目标系统的目录中
* 然后调整临时工具链，再编译目标系统中的，形成内部依赖的工具链
* 目标工具链的形成意味着临时工具链的使命已经完成，虽然现在临时工具链经过了调整，但后续的制作过程中不会再使用到它了
* 此时不用在意它的存在，也不需要这时去删除它，在最后完成目标系统后再将它连同临时系统一并删除

---

6. 建立目标系统

* 临时工具链虽然已经不再需要了，但目前目标系统除了目标工具链还一无所有
* 还需要用到临时系统中的各种各种目录以及其它常用命令，交互环境程序也还在使用临时系统中的命令
* 如同制作临时系统的时候需要的命令安装到临时系统中一样，可以人为的将临时系统中出现的所有的软件包都重新用目标工具链再次编译并安装到目标系统目录中
* 最终将完全替代掉临时系统中的所有软件包和命令
* 目标系统和临时系统的要求是不一样的，临时系统只需要为制作目标系统编译环境和简单的运行环境的支撑能力即可
* 但目标系统除了要具备临时系统所具有的功能之外还需要有更高的要求
* 比如网络的支持，程序进程的管理，系统启动等，因此还需要安装许多Linux系统中常见的软件包
* 至于关于常见软件包，这里不过过多枚举

---

7. 收尾工作
* 完成了目标系统后，就可以展开收尾工作了
* 包括删除临时系统，临时系统所有文件都存放在了`/tools`目录中，只需要删除`/tools`就可以了
* 还有一些公共的配置文件需要进行设置，如主机名，网络地址等，这些内容将在后续章节内进行介绍，这里先不再赘述

* 对于编译出来的命令程序还有一个需要注意的地方，很多软件包编译生成的程序文件带有许多调试信息，会占据相当大的磁盘空间
* 有的程序文件所附带的调试信息可以使其增加数倍的大小，主体代码只有几百KB的程序可能会超过1MB，去掉这些调试信息显得非常重要

* 调试信息的删除可以使用strip命令来完成，具体参数不进行过多阐述，需要注意的一点就是某一些程序或软件的调试信息中会与其静态函数库发生关联，如果去掉则可能导致静态函数库无法使用

---

8. 启动目标系统

* 让这个目标系统正常的启动起来
* 如果以LiveCD的方式进行制作，同时所使用的本地计算机内没有任何影片盘的启动器时，可以使用GRUB的启动程序
* 关于GRUB的使用这里不做过多阐述

---
