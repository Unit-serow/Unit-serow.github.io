---
title: MongoDB-4
date: 2020-02-17 23:52:29
tags: [NoSQL,随笔]
categories: [软件,数据库]
---

### MongoDB-4

* 剩余概念补充-1

**概念简述:**

1. 管道
2. 复制原理(创建副本集)
3. 分片技术(集群)

---

1. **管道(聚合)**

* 管道在Unix和Linux中一般用于将当前命令的输出结果作为下一个命令的参数
* MongoDB的聚合管道将MongoDB文档在一个管道处理完毕后将结果传递给下一个管道处理
* 管道操作是可以重复的
* 表达式：处理输入文档并输出
* 表达式是无状态的，只能用于计算当前聚合管道的文档，不能处理其它的文档

**常用聚合框架(模式)一览:**

|框架|作用|
|:----|:----|
|$project|修改输入文档的结构。可以用来重命名、增加或删除域，也可以用于创建计算结果以及嵌套文档|
|$match|用于过滤数据，只输出符合条件的文档，$match使用MongoDB的标准查询操作|
|$limit|用来限制MongoDB聚合管道返回的文档数|
|$skip|在聚合管道中跳过指定数量的文档，并返回余下的文档|
|$unwind|将文档中的某一个数组类型字段拆分成多条，每条包含数组中的一个值|
|$group|将集合中的文档分组，可用于统计结果|
|$sort|将输入文档排序后输出|
|$geoNear|输出接近某一地理位置的有序文档|

---

2. MongoDB复制原理(创建副本集)

* MongoDB复制是将数据同步在多个服务器的过程
* 复制提供了数据的冗余备份，并在多个服务器上存储数据副本，提高了数据的可用性， 并可以保证数据的安全性
* 复制还允许从硬件故障和服务中断中恢复数据

* 复制作用:
> 保障数据的安全性
> 数据高可用性`(24*7)`
> 灾难恢复
> 无需停机维护(如备份，重建索引，压缩)
> 分布式读取数据

**MongoDB复制原理**

* mongodb的复制至少需要两个节点
> 其中一个是主节点，负责处理客户端请求，其余的都是从节点，负责复制主节点上的数据
* mongodb各个节点常见的搭配方式为：一主一从、一主多从
* 主节点记录在其上的所有操作oplog，从节点定期轮询主节点获取这些操作
> 然后对本地的数据副本执行这些操作，从而保证从节点的数据与主节点一致

* 复制的逻辑结构简述:
* 客户端从主节点读取数据，在客户端写入数据到主节点时， 主节点与从节点进行数据交互保障数据的一致性
> `Client Application-Write/Reads->Primary-Replication/Replication->Secondary/Secondary`

---

**MongoDB副本集设置**
1. 利用同一个MongoDB来做MongoDB主从模型
2. 通过指定`--replSet`选项来启动mongoDB，`--replSet`基本语法格式如下:
> `mongod --port "PORT" --dbpath "YOUR_DB_DATA_PATH" --replSet "REPLICA_SET_INSTANCE_NAME"`

**参数说明:**
1. `REPLICA_SET_INSTANCE_NAME`为所选实例命名
1. 指定MongoDB实例所处端口(端口号)
2. 此时会启动并连接MongoDB服务
3. 在Mongo客户端可以使用命令`rs.initiate()`来启动一个新的副本集
4. 可以使用`rs.conf()`来查看副本集的配置
5. 查看副本集状态执行`rs.status()`命令

**副本集特征:**
* N 个节点的集群
* 任何节点可作为主节点
* 所有写入操作都在主节点上
* 自动故障转移
* 自动恢复

* rs.add()方法用于添加副本集的成员
* rs.add() 命令基本语法格式:
> `rs.add(HOST_NAME:PORT)`


* MongoDB中只能通过主节点将Mongo服务添加到副本集中
> 判断当前运行的Mongo服务是否为主节点可以使用命令`db.isMaster()`

* MongoDB的副本集与常见的主从有所不同
> 主从在主机宕机后所有服务将停止
> 而副本集在主机宕机后
> 副本会接管主节点成为主节点
> 不会出现宕机现象

---

3. **分片技术(集群)**

* 在Mongodb里面存在另一种集群，就是分片技术,可以满足MongoDB数据量大量增长的需求
* 当MongoDB存储海量的数据时，一台机器可能不足以存储数据，也可能不足以提供可接受的读写吞吐量
> 此时就可以通过在多台机器上分割数据，使得数据库系统能存储和处理更多的数据

**分片技术的作用:**

* 复制所有的写入操作到主节点
* 延迟的敏感数据会在主节点查询
* 有效解决单个副本集限制在12个节点的问题
* 能解决当请求量巨大时会出现内存不足
* 能够解决本地磁盘不足
* 可以避免价格昂贵的垂直扩展

**逻辑简述:**
> `(APP Server[Router(mongos)])|(APP Server[Router(mongos)])<-2 or more Routes-><->(3*Config Server)<-><-2 or more Shards->(Shard(replica set))|(Shard(replica set))`

* 组件描述:
> Shard:用于存储实际的数据块，实际生产环境中一个shard server角色可由几台机器组个一个replica set承担，防止主机单点故障
> Config Server:mongod实例，存储了整个 ClusterMetadata，其中包括 chunk信息
> Query Routers:前端路由，客户端由此接入，且让整个集群看上去像单一数据库，前端应用可以透明使用

* 实例不进行阐述

---

**其它概念:**

1. 数据备份与恢复
2. 监控部署
3. 其他语言接口
4. 关系
5. 数据库引用
6. MongoDB覆盖索引查询
7. Map Reduce
8. 固定集合(Capped Collections)

---

1. 查询分析
2. 高级索引
3. 索引限制
4. 原子操作
5. 全文检索
6. ObjectId
7. 自动增长

---

* 正则表达式
* 操作符
* 运算符
* 管理工具: 
> Rockmongo
> GridFS

---

* 有待补充...

---
